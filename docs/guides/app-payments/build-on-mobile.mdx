---
sidebar_position: 4
---

import Tabs from "@theme/Tabs"
import TabItem from "@theme/TabItem"

# Build on Mobile

This page details how MobilePay app payments should be implemented in your Android/iOS app.

## Prerequisites and Assumptions

<Tabs
  groupId="operating-systems"
  defaultValue="android"
  values={[
    { label: 'Android', value: 'android', },
    { label: 'iOS', value: 'ios', },
  ]
}>
<TabItem value="android">

This guide assumes:

- You already have backend services integrated with [MobilePay APIs](/docs/guides/app-payments/how-it-works).
- Your app uses [minSdkVersion](https://developer.android.com/training/basics/supporting-devices/platforms.html#sdk-versions) API 23 (Marshmallow, 6.0) or later.
- You are generally familiar with developing applications on Android.

</TabItem>

<TabItem value="ios">

This guide assumes:

- You already have backend services integrated with [MobilePay APIs](/docs/guides/app-payments/how-it-works).
- Your app handles a custom URL scheme. See [Apple documentation](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app) for more details.
- You are generally familiar with developing applications on iOS.

</TabItem>
</Tabs>

:::caution Make sure you are compliant with mobile application distribution service rules!
Using app payments for digital sales might not be allowed by some mobile application distribution services (Google Play, App Store, etc.) and might result in your application being removed. Please review the terms of service for the respective mobile application distribution services you use to ensure that you are compliant with their guidelines.
:::

## Create Payment

First, you'll need to create payment. To do this you should call your backend service that is implemented as described [here](/docs/payments-refunds/create-payments). This service call should return a response that contains a deep link needed to launch the MobilePay app.

## Redirect to MobilePay

Now that we have the deep link let's open MobilePay app.

<Tabs
  groupId="operating-systems"
  defaultValue="android"
  values={[
    { label: 'Android', value: 'android', },
    { label: 'iOS', value: 'ios', },
  ]
}>
<TabItem value="android">

```kotlin title="Kotlin"
fun openMobilePay(deepLink: String) {
    try {
        val intent = Intent(Intent.ACTION_VIEW).apply {
            data = Uri.parse(deepLink)
        }
        startActivity(intent)
        // At this point we know that MobilePay will be launched.
        // Consider navigating to a new screen here.
    } catch (exception: ActivityNotFoundException) {
        // Inform the user that MobilePay is not installed.
    }
}
```

```java title="Java"
void openMobilePay(String deepLink) {
    try {
        Intent intent = new Intent(Intent.ACTION_VIEW);
        intent.setData(Uri.parse(deepLink));
        startActivity(intent);
        // At this point we know that MobilePay will be launched.
        // Consider navigating to a new screen here.
    } catch (android.content.ActivityNotFoundException exception) {
        // Inform the user that MobilePay is not installed.
    } catch (NullPointerException exception) {
        // Null deepLink was passed in.
    }
}
```

</TabItem>

<TabItem value="ios">

```swift title="Swift"
UIApplication.shared.open(redirectUrl, options: [:], completionHandler: { success in
    if success {
        // Handle success.
    } else {
        // Handle failure. Most likely MobilePay app is not present on the user's device.
    }
})
```

</TabItem>
</Tabs>

After this, the MobilePay app will be launched and the user will be able to proceed with the payment flow.

## Returning to Your App

There are multiple ways a user can return to your app:

- User approves the payment and is redirected back to your app.
- User cancels the payment and is redirected back to your app.
- User fails to complete the payment due to some kind of error and is redirected back to your app.
- User closes the app before/after reservation using the native app switcher.
- User presses back in the MobilePay Login screen.

All these can be grouped into:

- App switching.
- Redirect.

The following section addresses how each one should be handled.

### App Switching

<Tabs
  groupId="operating-systems"
  defaultValue="android"
  values={[
    { label: 'Android', value: 'android', },
    { label: 'iOS', value: 'ios', },
  ]
}>
<TabItem value="android">

At any point user can close MobilePay app and just return to your app. **This can happen even if payment is already reserved!** Since it is unknown if your app was opened after completed payment, you'll need to check payment state each time your app returns to the foreground. For this, you should use your backend service that provides current state of payment (more details [here](/docs/payments-refunds/create-payments)).

</TabItem>

<TabItem value="ios">

At any point user can close MobilePay app and just return to your app. **This can happen even if payment is already reserved!** Since it is unknown if your app was opened after completed payment, you'll need to check payment state each time your app returns to the foreground. For this, you should use your backend service that provides current state of payment (more details [here](/docs/payments-refunds/create-payments)).

Example how to handle case when user manually switches to your app:

```swift title="Swift"
let observer = NotificationCenter.default.addObserver(forName: UIApplication.didBecomeActiveNotification, object: nil, queue: nil, using: { _ in
    // Check payment status - poll if needed.
})
```

Don't forget to unregister from notification when it's not needed:

```swift title="Swift"
NotificationCenter.default.removeObserver(observer)
```

</TabItem>
</Tabs>

### Redirect from MobilePay

<Tabs
  groupId="operating-systems"
  defaultValue="android"
  values={[
    { label: 'Android', value: 'android', },
    { label: 'iOS', value: 'ios', },
  ]
}>
<TabItem value="android">

The other scenario is that the MobilePay app tries to automatically navigate back to your app. For this to work you'll need:

- Valid deep link to a place that knows how to proceed with the flow ([official deep linking guide](https://developer.android.com/training/app-links/deep-linking)).
- Provide this deep link during [payment creation](#create-payment).

In the general case, this deep link should open the app screen which handles the "App switching" scenario described above, and just treat it the same way as if the user manually navigated to your app.

</TabItem>

<TabItem value="ios">

Example how to handle automatic redirect from the MobilePay app:

```swift
class AppDelegate: NSObject, UIApplicationDelegate {

    func application(_ app: UIApplication, open url: URL, options: [UIApplication.OpenURLOptionsKey : Any] = [:]) -> Bool {
        // Validate that url is from MobilePay and check payment status - poll if needed.
        return true
    }
}
```

</TabItem>
</Tabs>

## All done

Now everything should be ready for testing! Sandbox testing guide is [here](/docs/testing).

:::caution Make sure you are using the correct MobilePay app!
MobilePay supports multiple countries, but cross-country payments are not enabled.
:::

Having troubles with this guide? Be sure to [contact us](mailto:developer@mobilepay.dk) .
